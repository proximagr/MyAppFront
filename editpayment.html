<!DOCTYPE html>
<html>
<head>
  <title>Payment Management</title>
  <style>
    .container {
      max-width: 500px;
      margin: 0 auto;
      padding: 20px;
    }

    label, select {
      display: block;
      margin-bottom: 10px;
    }

    button {
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Payment Management</h2>
    <label for="customer">Select Customer:</label>
    <select id="customer" onchange="loadProjects()">
      <option value="">-- Select Customer --</option>
    </select>

    <label for="project">Select Project:</label>
    <select id="project" onchange="loadPayments()">
      <option value="">-- Select Project --</option>
    </select>

    <h3>Payments:</h3>
    <div id="payments"></div>
  </div>

  <script>
    // Function to fetch the list of customers from the backend
    async function loadCustomers() {
      const response = await window.archpro.fetch('/list-users');
      const customers = await response.json();

      const customerSelect = document.getElementById('customer');
      customerSelect.innerHTML = '<option value="">-- Select Customer --</option>';

      customers.forEach(customer => {
        const option = document.createElement('option');
        option.value = customer.id;
        option.textContent = customer.name;
        customerSelect.appendChild(option);
      });
    }

    // Function to fetch the list of projects for the selected customer from the backend
    async function loadProjects() {
      const customerId = document.getElementById('customer').value;
      if (!customerId) {
        document.getElementById('project').innerHTML = '<option value="">-- Select Project --</option>';
        return;
      }

      const response = await window.archpro.fetch(`/list-customerprojects?customer_id=${customerId}`);
      const projects = await response.json();

      const projectSelect = document.getElementById('project');
      projectSelect.innerHTML = '<option value="">-- Select Project --</option>';

      projects.forEach(project => {
        const option = document.createElement('option');
        option.value = project.id;
        option.textContent = project.project;
        projectSelect.appendChild(option);
      });
    }

    // Function to fetch the list of payments for the selected project from the backend
    async function loadPayments() {
      const projectId = document.getElementById('project').value;
      if (!projectId) {
        document.getElementById('payments').innerHTML = '';
        return;
      }

      const response = await window.archpro.fetch(`/list-projectspayments?project_id=${projectId}`);
      const payments = await response.json();

      const paymentsContainer = document.getElementById('payments');
      paymentsContainer.innerHTML = '';

      payments.forEach(payment => {
        const paymentDiv = document.createElement('div');
        paymentDiv.innerHTML = `
          <p><strong>ID:</strong> ${payment.id}</p>
          <p><strong>Payment:</strong> ${payment.payment}</p>
          <p><strong>Date:</strong> ${payment.date}</p>
          <button onclick="editPayment(${payment.id})">Edit</button>
          <button onclick="deletePayment(${payment.id})">Delete</button>
          <hr>
        `;
        paymentsContainer.appendChild(paymentDiv);
      });
    }

    // Function to edit a payment
    async function editPayment(paymentId) {
      const newPayment = prompt('Enter new payment amount:');
      if (newPayment === null) {
        return; // User canceled
      }

      const response = await window.archpro.fetch(`/update-payments/${paymentId}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ payment: newPayment })
      });

      if (response.ok) {
        alert('Payment updated successfully');
        loadPayments();
      } else {
        alert('Failed to update payment');
      }
    }

    // Function to delete a payment
    async function deletePayment(paymentId) {
      const confirmDelete = confirm('Are you sure you want to delete this payment?');
      if (!confirmDelete) {
        return;
      }

      const response = await window.archpro.fetch(`/delete-payment/${paymentId}`, {
        method: 'DELETE'
      });

      if (response.ok) {
        alert('Payment deleted successfully');
        loadPayments();
      } else {
        alert('Failed to delete payment');
      }
    }

    // Load customers on page load
    window.addEventListener('load', loadCustomers);
  </script>
</body>
</html>
