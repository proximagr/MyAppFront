<!DOCTYPE html>
<html>
<head>
  <title>Payment Management</title>
  <style>
    .container {
      max-width: 500px;
      margin: 0 auto;
      padding: 20px;
    }

    label, select {
      display: block;
      margin-bottom: 10px;
    }

    button {
      margin-top: 10px;
    }
  </style>
</head>
<body>
    <script src="utility.js"></script>
  <div class="container">
    <h2>Payment Management</h2>
    <label for="customer">Select Customer:</label>
    <select id="customer" onchange="loadProjects()">
      <option value="">-- Select Customer --</option>
    </select>

    <label for="project">Select Project:</label>
    <select id="project" onchange="loadPayments()">
      <option value="">-- Select Project --</option>
    </select>

    <h3>Payments:</h3>
    <div id="payments"></div>
  </div>

  <script>
    // Function to fetch the list of customers from the backend
async function loadCustomers() {
  try {
    const response = await window.archpro.fetch('/list-users');
    const customers = response;

    const customerSelect = document.getElementById('customer');
    customerSelect.innerHTML = '<option value="">-- Select Customer --</option>';

    customers.forEach((customer) => {
      const option = document.createElement('option');
      option.value = customer.id;
      option.textContent = customer.name;
      customerSelect.appendChild(option);
    });
  } catch (error) {
    console.error(error);
    alert('Failed to load customers. Please try again.');
  }
}

// Function to fetch the list of projects for the selected customer from the backend
async function loadProjects() {
  try {
    const customerId = document.getElementById('customer').value;
    if (!customerId) {
      document.getElementById('project').innerHTML =
        '<option value="">-- Select Project --</option>';
      return;
    }

    const response = await window.archpro.fetch(`/list-customerprojects?customer_id=${customerId}`);
    const projects = response;

    const projectSelect = document.getElementById('project');
    projectSelect.innerHTML = '<option value="">-- Select Project --</option>';

    projects.forEach((project) => {
      const option = document.createElement('option');
      option.value = project.id;
      option.textContent = project.project;
      projectSelect.appendChild(option);
    });
  } catch (error) {
    console.error(error);
    alert('Failed to load projects. Please try again.');
  }
}

// Function to fetch the list of payments for the selected project from the backend
async function loadPayments() {
  try {
    const projectId = document.getElementById('project').value;
    if (!projectId) {
      document.getElementById('payments').innerHTML = '';
      return;
    }

    const response = await window.archpro.fetch(`/list-projectspayments?project_id=${projectId}`);
    const payments = response;

    const paymentsContainer = document.getElementById('payments');
    paymentsContainer.innerHTML = '';

    payments.forEach((payment) => {
      const paymentDiv = document.createElement('div');
      paymentDiv.innerHTML = `
          <p><strong>ID:</strong> ${payment.id}</p>
          <p><strong>Payment:</strong> ${payment.payment}</p>
          <p><strong>Date:</strong> ${payment.date}</p>
          <button onclick="editPayment(${payment.id})">Edit</button>
          <button onclick="deletePayment(${payment.id})">Delete</button>
          <hr>
        `;
      paymentsContainer.appendChild(paymentDiv);
    });
  } catch (error) {
    console.error(error);
    alert('Failed to load payments. Please try again.');
  }
}


    // Function to edit a payment
async function editPayment(paymentId) {
  try {
    // Retrieve the payment details from the backend using the payment ID
    const response = await window.archpro.fetch(`/get-payment?id=${paymentId}`);
    const payment = response;

    // Prompt the user to enter the updated payment information
    const updatedPayment = prompt('Enter the updated payment:', payment.payment);
    if (updatedPayment === null) {
      return; // User canceled the prompt
    }

    // Send the updated payment to the backend for editing
    await window.archpro.fetch(`/edit-payment?id=${paymentId}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        payment: updatedPayment
      })
    });

    // Reload the payments list to reflect the changes
    loadPayments();
  } catch (error) {
    console.error(error);
    alert('Failed to edit the payment. Please try again.');
  }
}

// Function to delete a payment
async function deletePayment(paymentId) {
  try {
    // Confirm with the user before deleting the payment
    const confirmDelete = confirm('Are you sure you want to delete this payment?');
    if (!confirmDelete) {
      return;
    }

    // Send a request to the backend to delete the payment
    await window.archpro.fetch(`/delete-payment?id=${paymentId}`, {
      method: 'DELETE'
    });

    // Reload the payments list to reflect the changes
    loadPayments();
  } catch (error) {
    console.error(error);
    alert('Failed to delete the payment. Please try again.');
  }
}


    // Load customers on page load
    window.addEventListener('load', loadCustomers);
  </script>
</body>
</html>
