<!-- index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Edit/Delete Payment</title>
</head>
<body>
  <h1>Edit/Delete Payment</h1>
  
  <div id="customer-section">
    <label for="customer">Select Customer:</label>
    <select id="customer" name="customer"></select>
  </div>
  
  <div id="project-section">
    <label for="project">Select Project:</label>
    <select id="project" name="project"></select>
  </div>
  
  <div id="payments-section">
    <h2>Payments</h2>
    <table id="payments-table">
      <thead>
        <tr>
          <th>Payment</th>
          <th>Date</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="payments-list"></tbody>
    </table>
  </div>
  
  <script src="login.js"></script>
  <script>
    const customerSelect = document.getElementById('customer');
    const projectSelect = document.getElementById('project');
    const paymentsTable = document.getElementById('payments-table');
    const paymentsList = document.getElementById('payments-list');
    const authToken = localStorage.getItem('authToken');
    
    // Fetch customers and populate the customer select dropdown
    fetch(window.archpro.getApiPath('/customers'), {
      headers: {
        'Authorization': `Bearer ${authToken}`
      }
    })
    .then(response => response.json())
    .then(customers => {
      customers.forEach(customer => {
        const option = document.createElement('option');
        option.value = customer.id;
        option.textContent = customer.name;
        customerSelect.appendChild(option);
      });
    })
    .catch(error => console.error('Error fetching customers:', error));
    
    // Fetch projects for the selected customer and populate the project select dropdown
    customerSelect.addEventListener('change', () => {
      const customerId = customerSelect.value;
    
      // Clear project select dropdown
      projectSelect.innerHTML = '';
    
      fetch(window.archpro.getApiPath(`/customers/${customerId}/projects`), {
        headers: {
          'Authorization': `Bearer ${authToken}`
        }
      })
      .then(response => response.json())
      .then(projects => {
        projects.forEach(project => {
          const option = document.createElement('option');
          option.value = project.id;
          option.textContent = project.name;
          projectSelect.appendChild(option);
        });
    
        // Fetch payments for the selected project
        fetchPayments();
      })
      .catch(error => console.error('Error fetching projects:', error));
    });
    
    // Fetch payments for the selected project and populate the payments table
    projectSelect.addEventListener('change', fetchPayments);
    
    function fetchPayments() {
      const projectId = projectSelect.value;
    
      fetch(window.archpro.getApiPath(`/projects/${projectId}/payments`), {
        headers: {
          'Authorization': `Bearer ${authToken}`
        }
      })
      .then(response => response.json())
      .then(payments => {
        paymentsList.innerHTML = '';
    
        payments.forEach(payment => {
          const row = document.createElement('tr');
          const paymentCell = document.createElement('td');
          const dateCell = document.createElement('td');
          const actionCell = document.createElement('td');
          const editButton = document.createElement('button');
          const deleteButton = document.createElement('button');
    
          paymentCell.textContent = payment.payment;
          dateCell.textContent = payment.date;
    
          editButton.textContent = 'Edit';
          editButton.addEventListener('click', () => editPayment(payment.id));
    
          deleteButton.textContent = 'Delete';
          deleteButton.addEventListener('click', () => deletePayment(payment.id));
    
          actionCell.appendChild(editButton);
          actionCell.appendChild(deleteButton);
    
          row.appendChild(paymentCell);
          row.appendChild(dateCell);
          row.appendChild(actionCell);
    
          paymentsList.appendChild(row);
        });
      })
      .catch(error => console.error('Error fetching payments:', error));
    }
    
    function editPayment(paymentId) {
      // Redirect to the edit payment page with the paymentId as a query parameter
      window.location.href = `/edit-payment.html?paymentId=${paymentId}`;
    }
    
    function deletePayment(paymentId) {
      if (confirm('Are you sure you want to delete this payment?')) {
        fetch(window.archpro.getApiPath(`/delete-payment/${paymentId}`), {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${authToken}`
          }
        })
        .then(response => {
          if (response.ok) {
            alert('Payment deleted successfully');
            // Fetch payments again to update the table
            fetchPayments();
          } else {
            alert('Failed to delete payment');
          }
        })
        .catch(error => console.error('Error deleting payment:', error));
      }
    }
  </script>
</body>
</html>
